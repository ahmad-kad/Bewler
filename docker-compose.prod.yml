# Production Docker Compose for URC 2026 Robotics Platform
# Optimized for competition deployment

version: '3.8'

services:
  # ==================================================
  # CORE INFRASTRUCTURE
  # ==================================================
  ros2-core:
    image: ros:humble-ros-core
    container_name: urc2026-ros2-core-prod
    environment:
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-42}
      - URC_ENV=production
    command: ["roscore"]
    healthcheck:
      test: ["CMD", "ros2", "node", "list"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - urc-prod-network

  # ==================================================
  # MOCK SYSTEMS (can be replaced with real hardware)
  # ==================================================
  can-mock-simulator:
    build:
      context: .
      dockerfile: docker/Dockerfile.universal
      target: can-mock-service
    container_name: urc2026-can-mock-prod
    ports:
      - "127.0.0.1:8766:8766"  # Only expose locally for security
    environment:
      - PYTHONPATH=/home/urc
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-42}
      - URC_ENV=production
      - USE_MOCK_CAN=true  # Clearly marked as mock
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.path.append('.'); from bridges.can_mock_simulator import CANBusMockSimulator; print('MOCK CAN OK')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - urc-prod-network
    # Production security: no external access
    profiles:
      - mock  # Only start when explicitly requested

  websocket-bridge:
    build:
      context: .
      dockerfile: docker/Dockerfile.universal
      target: websocket-bridge-service
    container_name: urc2026-websocket-bridge-prod
    ports:
      - "127.0.0.1:8765:8765"  # Only expose locally
    environment:
      - PYTHONPATH=/home/urc
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-42}
      - URC_ENV=production
      - USE_MOCK_CAN=true
    depends_on:
      - ros2-core
    healthcheck:
      test: ["CMD", "python3", "-c", "import asyncio, websockets; print('WebSocket OK')"]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - urc-prod-network

  # ==================================================
  # AUTONOMY SYSTEM (Production Optimized)
  # ==================================================
  autonomy-system:
    build:
      context: .
      dockerfile: docker/Dockerfile.universal
      target: state-management-service
    container_name: urc2026-autonomy-prod
    environment:
      - PYTHONPATH=/home/urc
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-42}
      - URC_ENV=production
      - USE_MOCK_CAN=true
    depends_on:
      ros2-core:
        condition: service_healthy
    volumes:
      - ./config:/home/urc/config:ro
      - ros2_prod_logs:/home/urc/.ros/log
    healthcheck:
      test: ["CMD", "timeout", "5", "ros2", "node", "list", "|", "grep", "-q", "state_machine"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped
    networks:
      - urc-prod-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

  safety-service:
    build:
      context: .
      dockerfile: docker/Dockerfile.universal
      target: safety-service
    container_name: urc2026-safety-prod
    environment:
      - PYTHONPATH=/home/urc
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-42}
      - URC_ENV=production
    depends_on:
      autonomy-system:
        condition: service_healthy
    volumes:
      - ./config:/home/urc/config:ro
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.path.append('.'); from safety_system.safety_manager import SafetyManager; sm = SafetyManager(); print('Safety OK')"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - urc-prod-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

  navigation-service:
    build:
      context: .
      dockerfile: docker/Dockerfile.universal
      target: navigation-service
    container_name: urc2026-navigation-prod
    environment:
      - PYTHONPATH=/home/urc
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-42}
      - URC_ENV=production
    depends_on:
      autonomy-system:
        condition: service_healthy
    volumes:
      - ./config:/home/urc/config:ro
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.path.append('.'); import navigation; print('Navigation OK')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    networks:
      - urc-prod-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'

  computer-vision:
    build:
      context: .
      dockerfile: docker/Dockerfile.universal
      target: vision-service
    container_name: urc2026-vision-prod
    environment:
      - PYTHONPATH=/home/urc
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-42}
      - URC_ENV=production
    depends_on:
      autonomy-system:
        condition: service_healthy
    volumes:
      - ./config:/home/urc/config:ro
    healthcheck:
      test: ["CMD", "timeout", "10", "python3", "-c", "import cv2; import torch; print('Vision OK')"]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - urc-prod-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '2.0'

  mission-control:
    build:
      context: .
      dockerfile: docker/Dockerfile.universal
      target: mission-service
    container_name: urc2026-mission-prod
    environment:
      - PYTHONPATH=/home/urc
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-42}
      - URC_ENV=production
    depends_on:
      autonomy-system:
        condition: service_healthy
      websocket-bridge:
        condition: service_healthy
    volumes:
      - ./config:/home/urc/config:ro
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.path.append('.'); import missions.mission_executor; print('Mission OK')"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    networks:
      - urc-prod-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'

  # ==================================================
  # FRONTEND (Production with Nginx)
  # ==================================================
  frontend:
    build:
      context: .
      dockerfile: docker/Dockerfile.universal
      target: frontend-prod
    container_name: urc2026-frontend-prod
    ports:
      - "${FRONTEND_PORT:-8080}:80"
    environment:
      - NODE_ENV=production
    depends_on:
      websocket-bridge:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - urc-prod-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

  # ==================================================
  # MONITORING & LOGGING
  # ==================================================
  monitoring:
    build:
      context: .
      dockerfile: docker/Dockerfile.universal
      target: development
    container_name: urc2026-monitoring-prod
    ports:
      - "127.0.0.1:9090:9090"  # Only local access for security
    environment:
      - PYTHONPATH=/home/urc
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-42}
      - URC_ENV=production
    command: ["python3", "scripts/production_health_check.py"]
    depends_on:
      - autonomy-system
      - safety-service
      - navigation-service
      - computer-vision
      - frontend
    volumes:
      - ./config:/home/urc/config:ro
      - ros2_prod_logs:/home/urc/.ros/log:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/health"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - urc-prod-network
    profiles:
      - monitoring  # Only start when monitoring is needed

networks:
  urc-prod-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
    internal: false  # Allow external access for competition

volumes:
  ros2_prod_logs:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ./logs/production

# Environment file for production
# Create .env file with:
# ROS_DOMAIN_ID=42
# FRONTEND_PORT=8080
# COMPOSE_PROFILES=mock,monitoring  # Enable mock systems and monitoring
